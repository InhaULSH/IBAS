# 플랫폼 신뢰도 기반으로 가게 필터링 -> 광고성 리뷰 필터링(점수 계산) -> 광고성 리뷰 필터링(점수 가중치 및 점수 컷오프 최적화) -> 가게를 리뷰 내용에 따라 군집화 후 테마별 '찐맛집' 추천

# 데이터 전처리
# 네이버 리뷰의 경우 : '도입_URL', '가게이름', '카테고리', '전체평점', '방문자리뷰', '리뷰작성자' '리뷰작성수', '리뷰내용', '방문시간'
카카오맵 리뷰의 경우 : '가게이름', '카테고리', '전체평점', '평점건수', '리뷰작성자', '리뷰작성일', '작성자리뷰작성수', '작성자평균평점', '리뷰평점', '리뷰내용' 컬럼만 사용

# %% 플랫폼 신뢰도 기반 가게 필터링
# 조건 1: 카카오 평점 건수가 5 이상
# 조건 2: 카카오 평점이 유효한 숫자인 경우 (NaN이 아님)
# 조건 3: 네이버 평점이 유효한 숫자인 경우 (NaN이 아님)
# 조건 4: 네이버 평점이 카카오 평점 + 1.5보다 큰 경우 OR 네이버 리뷰의 긍정 확률과 카카오 리뷰의 긍정 확률이 일정수준 이상 차이나는 경우(X3_Sentiment의 매커니즘 활용)
# 위 4가지 조건을 모두 만족하는 가게는(AND 조건) 네이버 리뷰 데이터에서 삭제, 추천 대상에서 먼저 제외함

# %% 광고성 리뷰 필터링 - 피쳐 엔지니어링, 점수 계산
# 설문의 내용을 Ground Truth로 하여 광고성 리뷰와 자의적 리뷰에 많이 사용되는 키워드(AD_SUBSPICION_SEED, VOLUNTARY_PRESUMED_SEED) 를 도출, BERT를 사용하여 해당 키워드를 확장한다음 아래 8개를 피쳐를 바탕으로 '광고성 리뷰 확률' 정의
# 'X1_Organic_Count' : 형태소 분석기로 분석된 형태소 기준 자의적 리뷰로 추정되는 키워드(VOLUNTARY_PRESUMED_SEED)가 얼마나 존재하는가
# 'X2_Ad_Count' : 형태소 분석기로 분석된 형태소 기준 광고성 리뷰로 의심되는 키워드(AD_SUBSPICION_SEED)가 얼마나 존재하는가
# 'X3_Sentiment' : 한국어 모델로 분석한 결과 해당 리뷰 내용의 긍정 / 부정 확률이 어떻게 되는가, 단순히 광고성 / 자의적 작성 리뷰에 자주 등장하는 키워드의 빈도만으로 리뷰 내용을 분석 시 리뷰내용의 문맥과 감성을 무시할 여지가 생기므로 (예 : 맛과 서비스를 언급하고 나머지 부분은 언급하지 않았으나 내용은 비판적인 경우) 해당 피쳐로 보완
# 'X4_Specificity' : 해당 리뷰의 길이가 어떻게 되는가, 향후 리뷰 내용 기반으로 구체성을 측정하도록 발전시켜도 좋음
# 'X5_rating_mean' : 유저가 부여하는 평균적인 평점이 어떻게 되는가, 카카오맵 리뷰에서는 평균평점 컬럼 직접사용, 네이버 리뷰에서는 리뷰별 평점이 없으므로 최하점과 최고점의 평균값 사용 / 'X6_review_num' : 유저의 리뷰 작성수 / 'X7_content_sim' : 유저의 리뷰 내용의 유사성
# 'X8' : 바이럴 기간 작성 여부, 바이럴 기간은 단위 기간당 리뷰 작성수가 평균에 대해서 일정 수준 이상 떨어져있으면 바이럴 기간으로 정의
# X1 ~ X8의 피쳐를 1대1로 반영하여 로지스틱 회귀 또는 XGBoost를 사용하여 리뷰에 대해 "광고성 리뷰 확률, S_ad"를 산출

# 광고성 리뷰 필터링 - 점수 가중치 및 점수 컷오프 최적화
# 광고임을 직접 밝히는 키워드 (AD_CONFIRM_SEED) 존재 => 광고성 리뷰 확정
# 3점 이하 평점(카카오맵의 경우) 또는 부정적 언급(VOLUNTARY_CONFIRM_SEED) 존재 => 자의적 리뷰 확정
# 그 다음 이전 단계에서 광고성/자의적으로 확정된 리뷰들을 "약한 정답"으로 사용하고, 임의의 소수 리뷰를 각 개발자들이 임의로 분류한다음 이를 평균낸 값을 확률로 레이블링하여 "강한 정답" 으로 사용, "강한 정답" 의 경우 "약한 정답" 이 아닌 리뷰 중에서 선정, 해당 "약한 정답"과 "강한 정답"의 레이블을 정답으로 하여 나머지 리뷰의 분류 진행, 분류 모델은 로지스틱 회귀 및 XGBoost를 둘 다 사용해보고 성능 차이를 비교
# 광고성 확률의 각 피쳐의 가중치를 확정했으면 분류된 광고성 / 자의적 리뷰에 대해 광고성 확률의 분포를 확인, 각 그룹의 확률 분포가 겹치는 지점(로지스틱 회귀) 또는 정확도와 재현도, F1-Score 를 바탕으로 최적 점수 판단 기준 설정
# 최적화된 모델과 모델의 컷오프값을 joblib 라이브러리로 저장한다음 '점수 계산' 단계에서 다시 불러와 각 리뷰의 최종 확률 계산 및 광고성 / 자의적 분류 라벨링 진행

# %% 테마 기반 찐맛집 추천
# 해당 가게의 '자의적 리뷰' 로 분류된 리뷰 텍스에 대해 SBERT로 벡터화한 후 BERTopic을 사용하여 분석해 해당 가게의 주요 키워드 도출
# HDBSCAN과 같은 클러스터링 알고리즘으로 가게의 주요 키워드를 바탕으로 가게를 그룹화한 다음 각 그룹의 키워드들에 대해 다시 BERTopic을 사용하여 각 그룹의 테마를 설정, 이후 사용자가 테마를 선택하거나 원하는 테마를 직접 입력하면 가장 적절한 키워드의 가게들을 특정 기준순(리뷰 많은 순, 최근 리뷰 증가순 등)으로 나열하여 출력
# BERTopic의 원시 결과값은 단순한 단어의 나열이므로 (예 : '가성비', '정감있는', '찜닭', ... ) 이를 후처리하는 과정 필요, Google AI Studio는 무료 API Request 용량을 제공하므로 해당 API로 요청하여 제미나이의 후처리를 받은 응답을 서비스에 출력하면 됨 (예 : '인스타 감성 맛집', '숨은 혼밥 맛집' ... )
# 유저가 테마의 한 가게를 클릭하면, 대표 리뷰 및 네이버 지도 링크, 네이버 지도상 가게의 위치를 띄워 네이버 지도의 해당 가게 정보 사이트로 접근할 수 있도록 함
# 해당 프로젝트에서는 불가능하나 유저의 기존 리뷰 경향과 유사한 가게를 협업 필터링 또는 컨텐츠 기반 필터링으로 추천하는 개선사항도 있음